YUI.add("flickr-tags-getListPhoto-fetcher",function(t,o){"use strict";t.namespace("ModelFetchers")["flickr-tags-getListPhoto"]={run:function(a,e){var s=a.id,g={photo_id:s,extras:"autotags",lang:e.lang},r=this;return t.Promise.all([e.callAPI("flickr.tags.getListPhoto",g),e.getModelRegistry("photo-tags-models"),e.getModelRegistry("tag-models"),e.getModelRegistry("photo-autotags-models"),e.getModelRegistry("autotag-models")]).then(function(t){return r._processResponse(t,s,e.flipper)},t.FetcherErrorLogger(o))},_processResponse:function(o,a,e){var s,g=o[0],r=o[1],i=o[2],n=g.photo&&g.photo.tags&&void 0!==g.photo.tags.tag?g.photo.tags.tag.length:0,p=[],u=o[3],d=o[4],h=0,l=[];return n>0&&t.Array.each(g.photo.tags.tag,function(t){"string"==typeof t.content&&p.push(i.addOrUpdate({id:t.id,tagRaw:t.raw,tagValue:t.content,tagAuthorNSID:t.author,isMachineTag:t.machineTag,duplicateAutotagId:t.duplicateAutotag}))}),r.exists(a)?r.setValue(a,"tags",p):r.add({id:a,tags:p}),s={id:a},g.photo&&g.photo.autotags&&void 0!==g.photo.autotags.autotag&&(h=g.photo.autotags.autotag.length),h>0&&t.Array.each(g.photo.autotags.autotag,function(t){"string"==typeof t.content&&l.push(d.addOrUpdate({id:t.id,autotagValue:t.content,score:t.confidence,isPrivate:t.private}))}),s.autotags={page:1,perPage:1e3,pageContent:l,totalItems:h},u.exists(a)?u.setValue(a,"autotags",s.autotags):u.add(s),r.proxy(a)}}},"@VERSION@",{requires:["flickr-promise","api-helper"],optional:["tag-models","photo-tags-models"]});YUI.add("photo-tags-models",function(t){function e(t){e.superclass.constructor.call(this,t)}t.Models[this.name]=e,t.extend(e,t.FlickrModelRegistry,{name:this.name,remote:{read:function(e){return t.ModelFetchers["flickr-tags-getListPhoto"].run(e,this.appContext)},create:function(e){return t.ModelCreators["flickr-photos-addTags"].run(e,this.appContext)},delete:function(e){return t.ModelDeletors["flickr-photos-removeTag"].run(e,this.appContext)}},attributes:{tags:{isCollection:!0}}})},"@VERSION@",{requires:["flickr-model-registry","flickr-tags-getListPhoto-fetcher","flickr-photos-addTags-creator","flickr-photos-removeTag-deletor"]});YUI.add("flickr-photos-addTags-creator",function(t,o){"use strict";t.namespace("ModelCreators")["flickr-photos-addTags"]={run:function(s,e){var r=this;return t.Promise.all([e.callAPI("flickr.photos.addTags",this._processParams(s)),e.getModelRegistry("photo-tags-models"),e.getModelRegistry("tag-models")]).then(function(t){return r._processResponse(t,s)},function(t){throw s.fullResponse&&(t.photoIds=s.photoId),t}).then(null,t.FetcherErrorLogger(o))},_processParams:function(t){t.tags=t.tags||[];var o={};return o.photo_ids=t.photoId.join(","),o.tags=t.tags.join(","),t.fullResponse&&(o.full_response=1),o.extras="is_autotag",o},_processResponse:function(t,o){var s,e,r,a=t[0],n=t[1],i=t[2],d=[];if(s=a.errors,!o.fullResponse){for(a.tags.tag.forEach(function(t){i.exists(t.id)||i.add({id:t.id,tagRaw:t.raw,tagValue:t.content.replace(/\s/g,""),tagAuthorNSID:t.author,duplicateAutotagId:t.duplicateAutotag}),d.push(i.proxy(t.id))}),e=0;e<o.photoId.length;e++)r=o.photoId[e],n.exists(r)?d.forEach(function(t){void 0!==t&&n.getValue(r,"tags").push(t)}):n.add({id:r,tags:d});return d}if(s&&s.length>0)return s}}},"@VERSION@",{requires:["flickr-promise"],optional:["photo-tags-models","tag-models"]});YUI.add("vr-overlay-view",function(e,t){var i,n=require("hermes-core/flog")(t);i={css:{destinationContainer:"body",closeX:".close"},options:{}},e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return this.photoId=e.photoId,this.nsid=e.nsid,""===this.get("container").get("innerHTML")&&this.setContainerHTML(""),this.immersed=!1,this},subviewConfig:{},loadState:function(){var e=this;return this.appContext.getModel("photo-models",e.photoId).then(function(t){return e.set("photo",t),e.canVr().then(function(t){e.set("canVr",t)})})},buildContainer:function(){var e=this.get("canVr");return this.set("isActiveViewAgnostic",!0),e?(this.setContainerWithTemplate("vr-overlay"),this):this},buildErrorContainer:function(){this.setContainerHTML("")},activate:function(){var t=this;if(this.get("canVr"))return this.loadFlickvr().then(function(){var n=t.get("container");n.addClass("active"),n.one(i.css.closeX)&&t.registerEventHandler(n.one(i.css.closeX).on("click",e.bind(t.closeVr,t))),t.registerEventHandler(t.get("container").on("click",t.openVr,t)),t.isMobile||t.openVr()}).then(null,function(e){n.error("Failed to load flickvr from CDN",{err:e})}),this},loadFlickvr:function(){return new e.Promise(function(t,i){if(window.Flickvr)return t();e.Get.js("https://combo.staticflickr.com/ap/flickvr/version.js",function(o){return o?i():window.FlickvrVersion?void e.Get.js("https://combo.staticflickr.com/ap/flickvr/"+window.FlickvrVersion+".js",function(e){return e?i():(n.log("flickvr loaded successfully from CDN"),t())}):i()})})},hasEquirectangularTag:function(){return this.appContext.getModel("photo-tags-models",this.photoId).then(function(e){var t=!1;return e.toJSON().tags.forEach(function(e){"equirectangular"===e.tagRaw.toLowerCase()&&(t=!0)}),t})},inEquirectangularGroup:function(){return this.appContext.getModel("photo-groups-models",this.photoId).then(function(e){var t=!1;return e.toJSON().groups.forEach(function(e){"44671723@N00"===e.id&&(t=!0)}),t})},canVr:function(){var t,i,n=!1;return this.appContext.flipper.isFlipped("enable-vr")?((t=this.get("photo"))&&(i=t.getValue("aspectRatio"))&&i>=1.99&&i<=2.01&&(n=!0),n?e.Promise.all([this.appContext.callAPI("flickr.vr.isEquirectangular",{photo_id:t.id})]).then(function(t){return e.Promise.resolve(!!t[0].is_equirectangular)}):e.Promise.resolve(!1)):e.Promise.resolve(!1)},onParentViewEvent:function(e,t){if(t&&t[0])switch(t[0]){case"vrIconClicked":this.openVr();break;case"vKeyPressed":this.toggleVr()}},toggleVr:function(){this.immersed?this.closeVr():this.openVr()},openVr:function(t){if(this.immersed||t&&t.target.hasClass("close"))this.vr.controls&&this.vr.controls.autoRotate&&(this.vr.controls.autoRotate=!1);else{var i,n,o=this,r=this.get("photo").getLargestSize(),s=this.templates("flickr-balls")({}),a=new Image;t&&t.halt(),(n=e.Node.create("<div></div>")).addClass("vr-loading-layer"),n.addClass("fluid"),n.append(s),o.get("container").append(n),i=r.displayUrl,a.crossOrigin="anonymous",a.onload=function(){o.immersed=!0,o.vr=new window.Flickvr,o.vr.initialize(i,{container:o.get("container").getDOMNode(),useContainerDimensions:!o.isMobile,enableVrHeadset:o.appContext.flipper.isFlipped("enable-vr-headset"),autoRotate:!o.isMobile}).then(function(t){e.fire("photo:entering-vr"),t.style.position="absolute",o.vr.enterVR(),o.get("container").one(".vr-loading-layer").remove(),o.get("container").addClass("immersed"),o.escHandle=o.attachKeyEvent("down:27",e.betterThrottle(o.closeVr.bind(o),100))})},a.src=i}},closeVr:function(e){var t=this.get("container");e&&e.preventDefault(),this.vr&&this.vr.destroy(),this.escHandle&&(this.detachRegisteredEvent(this.escHandle),delete this.escHandle),this.immersed=!1,t.removeClass("immersed")},beforeDestroy:function(){this.set("lastContainer",this.get("container")),this.immersed&&this.closeVr()},destructor:function(){var e=this.get("lastContainer");e&&(e.remove(!0),this.set("lastContainer",null))}})},"@VERSION@",{requires:["flickr-view","better-throttle","get","hermes-template-vr-overlay","hermes-template-flickr-balls"],optional:["photo-models","photo-tags-models","photo-groups-models"],langBundles:["common","photo-page-scrappy"]});YUI.add("hermes-template-zoom-modal",function(a,l){var e=a.Template.Handlebars.revive({1:function(a,l,e,n,r){var s;return'<img src="'+a.escapeExpression("function"==typeof(s=null!=(s=e.smallSrc||(null!=l?l.smallSrc:l))?s:e.helperMissing)?s.call(null!=l?l:{},{name:"smallSrc",hash:{},data:r}):s)+'" class="zoom-small">'},3:function(a,l,e,n,r){var s;return'<img src="'+a.escapeExpression("function"==typeof(s=null!=(s=e.largeSrc||(null!=l?l.largeSrc:l))?s:e.helperMissing)?s.call(null!=l?l:{},{name:"largeSrc",hash:{},data:r}):s)+'" class="zoom-large">'},5:function(a,l,e,n,r){var s;return'<img src="'+a.escapeExpression("function"==typeof(s=null!=(s=e.xLargeSrc||(null!=l?l.xLargeSrc:l))?s:e.helperMissing)?s.call(null!=l?l:{},{name:"xLargeSrc",hash:{},data:r}):s)+'" class="zoom-xlarge">'},compiler:[7,">= 4.0.0"],main:function(a,l,e,n,r){var s,o=null!=l?l:{};return'<div class="zoom-modal hidden">\n\t<div class="zoom-photo-container">\n\t\t'+(null!=(s=e.if.call(o,null!=l?l.smallSrc:l,{name:"if",hash:{},fn:a.program(1,r,0),inverse:a.noop,data:r}))?s:"")+"\n\t\t"+(null!=(s=e.if.call(o,null!=l?l.largeSrc:l,{name:"if",hash:{},fn:a.program(3,r,0),inverse:a.noop,data:r}))?s:"")+"\n\t\t"+(null!=(s=e.if.call(o,null!=l?l.xLargeSrc:l,{name:"if",hash:{},fn:a.program(5,r,0),inverse:a.noop,data:r}))?s:"")+'\n\t\t<span class="facade-of-protection-zoom"></span>\n\t</div>\n</div>\n'},useData:!0}),n={};a.Array.each([],function(l){var e=a.Template.get("hermes/"+l);e&&(n[l]=e)}),a.Template.register("hermes/zoom-modal",function(l,r){return r=r||{},r.partials=r.partials?a.merge(n,r.partials):n,e(l,r)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("zoom-view",function(e){e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,forceGPU:null,slowMoMode:!1,sizes:{},supportsMultiLevelZooming:!1,currentZoomLevel:null,initializer:function(o){return this.photoId=o.photoId,this.disableIfSmall=!!o.disableIfSmall,YUI.Env.isServer||(e.config.win.location.search.indexOf("gpu=on")>-1?this.forceGPU=!0:e.config.win.location.search.indexOf("gpu=off")>-1&&(this.forceGPU=!1),this.currentZoomLevel=0),this},loadState:function(){var e=this;return this.appContext.getModel("photo-models",e.photoId).then(function(o){e.set("photo",o)})},buildContainer:function(){return this.setContainerHTML(""),this},activate:function(){var o=this,t=o.getZoomKeyScope();return this.get("photo").getValue("needsInterstitial")?this:(this.parentViewContainer=this.get("container").ancestor(".view"),o.registerEventHandler(o.get("container").on("click",function(e){e.preventDefault(),o.setCursorCoordsFromEvent(e),o.detectSlowMoMode(e),o.zoomIn(o.cursorCoords)})),o.registerEventHandler(e.on("photo:zoom",function(t){o.detectSlowMoMode({shiftKey:t.shift}),t.x&&t.y?(o.cursorCoords=[t.x-e.config.win.pageXOffset,t.y-e.config.win.pageYOffset],o.zoomIn(o.cursorCoords)):o.zoomIn()})),o.attachKeyEvent("down:90",e.betterThrottle(function(e){e.preventDefault(),o.detectSlowMoMode(e),o.canZoomIn()?o.zoomIn():o.zoomOut()},100),"*"),o.attachKeyEvent("down:27",e.betterThrottle(function(e){e.preventDefault(),o.detectSlowMoMode(e),o.zoomOut()},100),t),o.attachKeyEvent("down:37,38,39,40",e.betterThrottle(function(e){var t=[o.currentZoomRegion.left,o.currentZoomRegion.top];switch(e.preventDefault(),e.button){case 37:t[0]+=200;break;case 38:t[1]+=200;break;case 39:t[0]-=200;break;case 40:t[1]-=200}o.panZoomNode(t)},16),t),o.registerEventHandler(o.appContext.flapp.before("activeViewChange",function(t){e.fire("flickr:removeKeyEventScope",o.getZoomKeyScope()),o.detachRegisteredEvents(),o.detachEventHandlers(),o.cleanUp()})),this)},zoomIn:function(o){var t,i,n,r,s,a,h,d,l,g=this,c=this.getZoomPixelRatio(),u=this.getRegionForNode(this.get("container")),m=this.maxMsgNode;if(this.sizes=this.getSizes(),this.sizes.xlarge&&this.sizes.xlarge.url&&(this.supportsMultiLevelZooming=!0),this.supportsMultiLevelZooming?0===this.currentZoomLevel?n=this.sizes.large:1===this.currentZoomLevel&&(n=this.sizes.xlarge):n=this.sizes.large,r=this.isImageReadyToDisplay(this.sizes.medium.url),s=this.isImageReadyToDisplay(this.sizes.large.url),this.supportsMultiLevelZooming&&(a=this.isImageReadyToDisplay(this.sizes.xlarge.url)),this.disableIfSmall&&u.width>=this.sizes.large.width)return m||(m=this.maxMsgNode=e.Node.create('<div class="zoom-max-message">'+g.intlMessage({intlName:"photo-page-scrappy.ZOOM_MAX_MESSAGE"})+"</div>")),this.get("container").contains(m)||(m.addClass("hidden"),this.get("container").append(m)),e.soon(function(){m&&m.inDoc()&&(m.removeClass("hidden"),this.maxMsgNodeHidingTimer&&(clearTimeout(this.maxMsgNodeHidingTimer),delete this.maxMsgNodeHidingTimer),this.maxMsgNodeHidingTimer=setTimeout(function(){m&&m.inDoc()&&m.addClass("hidden")},3e3))}),void this.resetSlowMoMode();e.fire("flickr:setKeyEventScope",this.getZoomKeyScope()),this.zoomingIn=!0,this.panningAnimationHandle=e.AnimationManager.subscribe(function(){var t,i,n=g.getDeteriorationRateForEasing(),r={x:0,y:0},s={x:0,y:0},a={x:0,y:0};g.pendingCoords&&(r.x=parseInt(g.pendingCoords[0],10),r.y=parseInt(g.pendingCoords[1],10),g.currentCoords?(s.x=g.currentCoords[0],s.y=g.currentCoords[1]):(t=g.getZoomPanCoordsForCursor(o),i=g.constrainPanCoords(t),s.x=parseInt(i[0],10),s.y=parseInt(i[1],10)),r.x<s.x?a.x=s.x-Math.abs(r.x-s.x)*n:a.x=s.x+Math.abs(r.x-s.x)*n,r.y<s.y?a.y=s.y-Math.abs(r.y-s.y)*n:a.y=s.y+Math.abs(r.y-s.y)*n,a.x=parseInt(a.x,10),a.y=parseInt(a.y,10),a.x===s.x&&(r.x<s.x?a.x=s.x-1:r.x>s.x&&(a.x=s.x+1)),a.y===s.y&&(r.y<s.y?a.y=s.y-1:r.y>s.y&&(a.y=s.y+1)),a.x===r.x&&a.y===r.y||((!0===g.forceGPU||e.config.win.devicePixelRatio>1)&&!1!==g.forceGPU?g.zoomPhotoContainerNode.setStyle("transform","translate3d("+a.x+"px, "+a.y+"px, 0)"):g.zoomPhotoContainerNode.setStyle("transform","translate("+a.x+"px, "+a.y+"px)")),g.currentCoords=[a.x,a.y],a.x===r.x&&a.y===r.y&&delete g.pendingCoords)}),this.zoomNode?(this.zoomingOut=!1,(t=this.zoomNode).removeClass("hiding"),this.detachEventHandlers()):t=this.zoomNode=e.Node.create(this.templates("zoom-modal")({smallSrc:r?this.sizes.medium.url:this.sizes.small.url,largeSrc:s?this.sizes.large.url:"",xLargeSrc:a?this.sizes.xlarge.url:""})),i=this.zoomPhotoContainerNode=t.one(".zoom-photo-container"),this.zoomImageFullWidth=n.width/c,this.zoomImageFullHeight=n.height/c,o||(g.cursorCoords=o=[this.appContext.viewportData.viewport.width/2,this.appContext.viewportData.viewport.height/2]),h=this.getZoomPanCoordsForCursor(o),h=this.constrainPanCoords(h),d={left:h[0],top:h[1],width:this.zoomImageFullWidth,height:this.zoomImageFullHeight},0===g.currentZoomLevel?(i.setStyle("transition","none"),this.resizeZoomNode(u,!1)):this.resizeZoomNode(this.getRegionForNode(i),!1),t.on("click",function(e){g.zoomingIn||(e.preventDefault(),g.detectSlowMoMode(e),g.canZoomIn()?(g.setCursorCoordsFromEvent(e),g.zoomIn(g.cursorCoords)):g.zoomOut())}),e.one("body").append(t),i.setStyle("width",d.width),i.setStyle("height",d.height),e.soon(function(){g.zoomingIn&&(t.removeClass("hidden"),i.setStyle("transition",""),"ontouchstart"in document&&e.use("event-touch",function(){g.touchHandlers=[],g.touchHandlers.push(e.on("touchstart",function(e){e.changedTouches.length&&1===e.changedTouches.length&&(g.touching=[e.changedTouches[0].pageX,e.changedTouches[0].pageY])})),g.touchHandlers.push(e.on("touchmove",function(e){var o,t,i=e.pageX,n=e.pageY;g.touching&&e.changedTouches.length&&1===e.changedTouches.length&&(i=e.changedTouches[0].pageX,n=e.changedTouches[0].pageY,e.preventDefault(),o=i-g.touching[0],t=n-g.touching[1],g.touching=[i,n],g.panZoomNode([g.currentZoomRegion.left+o,g.currentZoomRegion.top+t]))})),g.touchHandlers.push(e.on("touchend",function(e){delete g.touching}))}),t.on("mousemove",g.zoomMouseMoveHandler.bind(g)),g.mouseWheelHandler=(function(){var e=g.zoomScrollWheelHandler.bind(g);return l="onwheel"in document.createElement("div")?"wheel":"mousewheel",g.zoomNode.getDOMNode().addEventListener(l,e,!1),{detach:function(){g.zoomNode.getDOMNode().removeEventListener(l,e,!1)}}})(),g.parentViewContainer.addClass("zoomed"),g.resizeZoomNode(d,!0).then(function(){g.zoomingIn&&(g.zoomingIn=!1,g.zoomedIn=!0,i.removeClass("zoom-level-"+g.currentZoomLevel),g.currentZoomLevel+=1,i.addClass("zoom-level-"+g.currentZoomLevel),g.zoomNode.toggleClass("max-zoom-level",!g.canZoomIn()),g.resetSlowMoMode(),g.panZoomNodeToCurrentCoords(),s||i.append('<img src="'+g.sizes.large.url+'" class="zoom-large">'),g.supportsMultiLevelZooming&&!a&&i.append('<img src="'+g.sizes.xlarge.url+'" class="zoom-xlarge">'))}))})},zoomOut:function(){var o=this,t=this.zoomNode;e.fire("flickr:removeKeyEventScope",this.getZoomKeyScope()),this.detachEventHandlers(),this.resizeZoomNode(this.getRegionForNode(this.get("container")),!0),t.addClass("hiding"),this.zoomedIn=!1,this.zoomingIn=!1,this.zoomingOut=!0,setTimeout(function(){o.zoomingOut&&t&&t._node&&(o.parentViewContainer.removeClass("zoomed"),t.removeClass("hiding"),t.addClass("hidden"),o.resetSlowMoMode(),setTimeout(function(){o.zoomingOut&&(o.cleanUp(),o.zoomingOut=!1,o.currentZoomLevel=0)},200))},this.getZoomTransitionTime()),delete this.pendingCoords,delete this.currentCoords},resizeZoomNode:function(o,t){var i,n,r=this,s=e.config.win.performance&&e.config.win.performance.now;return t?new e.Promise(function(t,a){function h(a){var d=(function(a){var h,d=((s?a:Date.now())-i)/r.getZoomTransitionTime();return d>=1?(h=o,r.isAnimatingZoom=!1,e.soon(t)):h={left:n.left+(o.left-n.left)*d,top:n.top+(o.top-n.top)*d,width:n.width+(o.width-n.width)*d,height:n.height+(o.height-n.height)*d},h})(a);(r.zoomingIn||r.zoomingOut)&&(r.resizeZoomNode(d,!1),d!==o&&e.config.win.requestAnimationFrame(h))}r.isAnimatingZoom=!0,i=s?e.config.win.performance.now():Date.now(),n=r.currentZoomRegion,e.config.win.requestAnimationFrame(h)}):(this.currentZoomRegion=o,this.zoomPhotoContainerNode&&this.zoomPhotoContainerNode.setStyle("transform","translate("+o.left+"px, "+o.top+"px) scale("+o.width/this.zoomImageFullWidth+")"),e.Promise.resolve())},zoomMouseMoveHandler:function(e){this.setCursorCoordsFromEvent(e),this.isAnimatingZoom||this.panZoomNodeToCurrentCoords()},zoomScrollWheelHandler:function(e){e.preventDefault();var o=e.wheelDeltaX,t=e.wheelDeltaY;void 0===o&&(o=-e.deltaX||0),void 0===t&&(t=-e.deltaY||0),this.panZoomNode([this.currentZoomRegion.left+o,this.currentZoomRegion.top+t])},getSizes:function(){var e=this.parentViewContainer.one(".low-res-photo"),o=this.parentViewContainer.one(".main-photo"),t=this.getLargerSize(o.getAttribute("src")),i=this.getLargestSize();return{small:{url:e.getAttribute("src"),width:parseInt(e.getAttribute("width"),10),height:parseInt(e.getAttribute("height"),10)},medium:{url:o.getAttribute("src"),width:parseInt(o.getAttribute("width"),10),height:parseInt(o.getAttribute("height"),10)},large:t,xlarge:t.url===i.url?null:i}},getLargerSize:function(o){var t,i,n,r=0,s=0;return this.appContext.flipper.isFlipped("enable-two-step-zoom")?("o"===(t=this.get("photo").getValue("ascendingSizes"))[t.length-1].key&&t.pop(),e.Array.each(t,function(e,t){e.src===o&&(r=t),"k"===e.key&&(s=t)}),(i=t[r+1])?(n=i,t[s]&&i.width<t[s].width&&(n=t[s])):n=t[t.length-1],n):this.getLargestSize()},getLargestSize:function(){return this.get("photo").getLargestSize()},getDeteriorationRateForEasing:function(){return.2},getZoomPixelRatio:function(){if(!this.appContext.flipper.isFlipped("enable-two-step-zoom"))return 1;var e,o=this.parentViewContainer.one(".main-photo");return o&&(o=o.getDOMNode()).naturalWidth&&(e=o.naturalWidth/parseInt(o.getAttribute("width"),10))<window.devicePixelRatio?e:window.devicePixelRatio?window.devicePixelRatio:1},getZoomEdgeMargin:function(){return 100},getZoomPanCoordsForCursor:function(e){if(e){var o=this.getZoomEdgeMargin(),t=[this.appContext.viewportData.getWidth(),this.appContext.viewportData.getHeight()],i=[this.zoomImageFullWidth,this.zoomImageFullHeight],n=[i[0]+2*o,i[1]+2*o],r=[e[0]/t[0],e[1]/t[1]];return[r[0]*(t[0]-n[0]),r[1]*(t[1]-n[1])]}},getRegionForNode:function(o){return{left:o.getX()-e.config.win.pageXOffset-this.getZoomEdgeMargin(),top:o.getY()-e.config.win.pageYOffset-this.getZoomEdgeMargin(),width:parseInt(o.getStyle("width"),10),height:parseInt(o.getStyle("height"),10)}},getZoomTransitionTime:function(){return 200*(this.slowMoMode?10:1)},getZoomKeyScope:function(){return this.name+this._yuid},canZoomIn:function(){return 0===this.currentZoomLevel||this.supportsMultiLevelZooming&&1===this.currentZoomLevel},setCursorCoordsFromEvent:function(o){return this.cursorCoords=[o.pageX-e.config.win.pageXOffset,o.pageY-e.config.win.pageYOffset],this.cursorCoords},panZoomNodeToCurrentCoords:function(){if(this.zoomedIn){var e=this.cursorCoords,o=this.getZoomPanCoordsForCursor(e);o&&this.panZoomNode(o)}},panZoomNode:function(e){this.currentZoomRegion.left===e[0]&&this.currentZoomRegion.top===e[1]||(e=this.constrainPanCoords(e),this.currentZoomRegion.left=e[0],this.currentZoomRegion.top=e[1],this.pendingCoords=e)},constrainPanCoords:function(e){var o,t,i=this.getZoomEdgeMargin(),n=[this.appContext.viewportData.getWidth(),this.appContext.viewportData.getHeight()],r=[this.zoomImageFullWidth,this.zoomImageFullHeight],s=[r[0]+2*i,r[1]+2*i];return 0,o=n[0]-r[0]-2*i,0,t=n[1]-r[1]-2*i,e[0]>0?e[0]=0:e[0]<o&&(e[0]=o),e[1]>0?e[1]=0:e[1]<t&&(e[1]=t),r[0]<n[0]&&(e[0]=.5*(n[0]-s[0])),r[1]<n[1]&&(e[1]=.5*(n[1]-s[1])),e},detectSlowMoMode:function(e){e.shiftKey&&(document.getSelection().removeAllRanges(),this.slowMoMode=!0)},resetSlowMoMode:function(){this.slowMoMode=!1},isImageReadyToDisplay:function(e){var o;return!!e&&(o=new Image,o.src=e,o.complete||o.naturalWidth)},detachEventHandlers:function(){this.zoomNode&&(this.zoomNode.detachAll("mousemove"),this.mouseWheelHandler&&this.mouseWheelHandler.detach(),this.touchHandlers&&(this.touchHandlers.forEach(function(e){e.detach()}),delete this.touchHandlers))},cleanUp:function(){this.zoomNode&&(this.zoomNode.remove(!0),this.zoomedIn=!1,this.zoomingIn=!1,this.zoomingOut=!1,delete this.zoomNode,delete this.zoomPhotoContainerNode,delete this.pendingCoords,delete this.currentCoords,this.panningAnimationHandle.detach())}})},"@VERSION@",{requires:["flickr-view","better-throttle","flickr-promise","hermes-template-zoom-modal","animation-manager"],optional:["photo-models"],langBundles:["photo-page-scrappy"]});YUI.add("hermes-template-google-moola-position",function(a,e){var l=a.Template.Handlebars.revive({1:function(a,e,l,n,r){return"upsell-fallback"},3:function(a,e,l,n,r){var t;return"width: "+a.escapeExpression("function"==typeof(t=null!=(t=l.adWidth||(null!=e?e.adWidth:e))?t:l.helperMissing)?t.call(null!=e?e:{},{name:"adWidth",hash:{},data:r}):t)+"px;"},5:function(a,e,l,n,r){var t;return"height: "+a.escapeExpression("function"==typeof(t=null!=(t=l.adHeight||(null!=e?e.adHeight:e))?t:l.helperMissing)?t.call(null!=e?e:{},{name:"adHeight",hash:{},data:r}):t)+"px;"},7:function(a,e,l,n,r){return'\t\t<a href="/account/upgrade/pro?feed"></a>\n'},9:function(a,e,l,n,r){return"\t"+a.escapeExpression((l.renderTrustedMarkup||e&&e.renderTrustedMarkup||l.helperMissing).call(null!=e?e:{},null!=e?e.extraMarkup:e,{name:"renderTrustedMarkup",hash:{},data:r}))+"\n"},compiler:[7,">= 4.0.0"],main:function(a,e,l,n,r){var t,i,s=null!=e?e:{},u=l.helperMissing,o=a.escapeExpression;return'<div class="g-moola-container '+o("function"==typeof(i=null!=(i=l.class||(null!=e?e.class:e))?i:u)?i.call(s,{name:"class",hash:{},data:r}):i)+" "+(null!=(t=l.if.call(s,null!=e?e.upsellFallback:e,{name:"if",hash:{},fn:a.program(1,r,0),inverse:a.noop,data:r}))?t:"")+"\" id='"+o("function"==typeof(i=null!=(i=l.adDiv||(null!=e?e.adDiv:e))?i:u)?i.call(s,{name:"adDiv",hash:{},data:r}):i)+"' style='"+(null!=(t=l.if.call(s,null!=e?e.adWidth:e,{name:"if",hash:{},fn:a.program(3,r,0),inverse:a.noop,data:r}))?t:"")+" "+(null!=(t=l.if.call(s,null!=e?e.adHeight:e,{name:"if",hash:{},fn:a.program(5,r,0),inverse:a.noop,data:r}))?t:"")+" "+o("function"==typeof(i=null!=(i=l.extraStyles||(null!=e?e.extraStyles:e))?i:u)?i.call(s,{name:"extraStyles",hash:{},data:r}):i)+"'>\n"+(null!=(t=l.if.call(s,null!=e?e.upsellFallback:e,{name:"if",hash:{},fn:a.program(7,r,0),inverse:a.noop,data:r}))?t:"")+"</div>\n"+(null!=(t=l.if.call(s,null!=e?e.extraMarkup:e,{name:"if",hash:{},fn:a.program(9,r,0),inverse:a.noop,data:r}))?t:"")},useData:!0}),n={};a.Array.each([],function(e){var l=a.Template.get("hermes/"+e);l&&(n[e]=l)}),a.Template.register("hermes/google-moola-position",function(e,r){return r=r||{},r.partials=r.partials?a.merge(n,r.partials):n,l(e,r)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("photo-well-media-scrappy-view",function(e,t){var i,o=require("hermes-core/flog")(t);i={photo:{render:function(){var e,t,i,o=this,n=this.get("photo"),s="";return o.preloadImage&&(o.preloadImage.onload=null),this.appContext.forceServerRender?t=e=this.getPhotoForDisplay({canvas:{width:Number.MAX_VALUE,height:Number.MAX_VALUE}}):(e=this.getPhotoForDisplay(),t=this.getPhotoForDisplay({includeSizes:["sq","q","t","s","n"]})),n.getValue("owner")&&(s=""===n.getValue("title").trim()?this.intlMessage({intlName:"common.UNTITLED"}):n.getValue("title"),s+=" | "+this.intlMessage({intlName:"common.BY_USER",user:n.getValue("owner").getValue("username")})),(i=this.get("container").one(".main-photo"))&&parseInt(i.getAttribute("width"),10)===e.width&&parseInt(i.getAttribute("height"),10)===e.height||this.setContainerWithTemplate("photo-well-media-scrappy",{width:e.width,height:e.height,src:t.url,highResSrc:e.url,imgAltText:s,needsInterstitial:n.getValue("needsInterstitial"),isSignedIn:this.appContext.getViewer().signedIn,isVideo:!1,isMinor:this.appContext.getViewer().isMinor}),YUI.Env.isServer?(this.serverWidth=e.width,this.serverHeight=e.height):n.getValue("needsInterstitial")||(o.preloadImage=new Image,o.preloadImage.onload=function(){if(!this.onloadFired&&o.isActiveAndInDOM()){this.onloadFired=!0;var e=o.get("container").one(".low-res-photo");o.get("container").one(".main-photo").removeClass("is-hidden").show(),e.hide()}},o.preloadImage.src=e.url,o.preloadImage.complete&&o.preloadImage.onload()),this}},video:{render:function(){var e=this.get("photo"),t=this.getPhotoForDisplay({excludeSizes:[]}),i=t.url;return this.appContext.flipper.isFlipped("disable-video-playback")&&(i="/images/en-us/video-unavailable.png"),!this.player||e.getValue("isVideoPending")||e.getValue("isVideoFailed")?(this.setContainerWithTemplate("photo-well-media-scrappy",{width:t.width,height:t.height,src:i,needsInterstitial:e.getValue("needsInterstitial"),isVideo:!0,isSignedIn:this.appContext.getViewer().signedIn,"zoom-view":""}),this):(e.getValue("isVideoPending")||e.getValue("isVideoFailed")||(this.player.dimension?(this.player.dimension("width",t.width),this.player.dimension("height",t.height)):this.player.resize(t.width,t.height)),this)}},ad:{render:function(){var t=e.config.flickr.moola.positions.interstitials[0],i={};return this.adId=e.guid(),i.adDiv=t.ad_div,1===t.ad_sizes.length&&(i.upsellFallback=!1,i.adHeight=t.ad_sizes[0].ad_height,i.adWidth=t.ad_sizes[0].ad_width),this.setContainerWithTemplate("google-moola-position",i),this}}},e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,subviewConfig:{"zoom-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1},"vr-overlay-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!0,destinationContainer:".photo-well-media-scrappy-view",disabled:function(){return!this.appContext.flipper.isFlipped("enable-vr")}}},initializer:function(e){return this.photoId=e.photoId,this.isAd=!!e.ad,this.adSlots=[],""===this.get("container").get("innerHTML")&&this.setContainerHTML(""),this},loadState:function(){var t=this;return this.appContext.getModel("photo-models",t.photoId).then(function(i){if(t.set("photo",i),i.getValue("isVideo"))return new e.Promise(function(t,i){e.use("flickr-video-player",function(){t()})})})},buildContainer:function(){return YUI.Env.isServer||this.set("clientRendered",!0),this.isAd?i.ad.render.call(this):this.get("photo").getValue("isVideo")?i.video.render.call(this):i.photo.render.call(this),!YUI.Env.isServer&&this.subviews["vr-overlay-view"]&&this.subviews["vr-overlay-view"].get("canVr")&&(this.canVR=!0,this.subviews["zoom-view"]&&this.subviews["zoom-view"].destroy({remove:!0})),this.get("photo").getValue("needsInterstitial")?this.get("container").addClass("has-interstitial"):this.get("container").removeClass("has-interstitial"),this},handleInterstitialDismissButtonClick:function(t){var i=this,n=this.get("personPreferences"),s=this.get("photo"),a=s.getValue("safetyLevel");e.rapidTracker.beacon(this.name,"restrictedContentInterstitialClick"),n.setValue("safeSearch",a),n.registry.remoteUpdate(i.appContext.auth.user.nsid).then(function(e){s.registry.attributeSearch({needsInterstitial:!0}).forEach(function(e){s.registry.getValue(e,"safetyLevel")<=n.getValue("safeSearch")&&s.registry.setValue(e,"needsInterstitial",!1)}),i.buildContainer(),i.fire("subviewViewEvent","photoWellResized")},function(e){o.error({err:e}),i.onError(i.intlMessage({intlName:"photo-page-scrappy.COULDNT_UPDATE_SETTINGS"}))})},onParentViewEvent:function(e,t){t&&"photoWellResized"===t[0]&&(this.get("photo").getValue("needsInterstitial")||(this.set("canvasSizeIsDirty",!0),this.buildContainer()))},activate:function(){var t=this,i=e.config.flickr.moola.positions.interstitials[0];return!this.get("photo").getValue("isVideo")||this.get("photo").getValue("isVideoPending")||this.get("photo").getValue("isVideoFailed")||(this.player=new e.FlickrVideoPlayer({container:t.get("container").one(".videoplayer"),model:t.get("photo"),appContext:t.appContext,videoNode:e.one("#video_1")?e.one("#video_1").getDOMNode():null,controlBar:{fullscreenToggle:!1}}),this.player.init(),this.on("destroy",function(){t.player&&(t.player.destroy(),t.player=null)})),this.get("photo").getValue("needsInterstitial")||this.registerEventHandler(e.on("flickr:photo-media-well-update",function(e){t.set("canvasSizeIsDirty",!0),t.buildContainer()})),this.appContext.getViewer().signedIn&&this.appContext.getModel("person-preferences-models",this.appContext.auth.user.nsid).then(function(e){t.set("personPreferences",e),t.get("photo").getValue("needsInterstitial")&&!this.appContext.getViewer().isMinor&&t.get("container").one(".restricted-interstitial-message button")&&t.registerEventHandler(t.get("container").one(".restricted-interstitial-message button").on("click",t.handleInterstitialDismissButtonClick,t))}),this.isAd&&window.googletag.cmd.push(function(){var e=window.googletag.defineSlot(i.name,i.ad_sizes.map(function(e){return[e.ad_width,e.ad_height]}),i.ad_div).addService(window.googletag.pubads());t.adSlots.push(e),window.googletag.pubads().refresh([e]),window.googletag.display(i.ad_div)}),this},showUpsell:function(){var e=this.get("container"),t=e.one("#interstitial-photo-upsell"),i=e.one("iframe");t&&t.addClass("show-upsell"),i&&i.setStyle("display","none")},onError:function(t){new e.Views.FluidModal({appContext:this.appContext,dismissOnOverlayClick:!0,showBodyLines:!0,showCancelButton:!1,showCancelX:!0,title:this.intlMessage({intlName:"common.ERROR"}),actionButtonLabel:this.intlMessage({intlName:"common.OK"}),message:t,classList:"scrappy-dialog"}).show()},getPhotoForDisplay:function(e){var t,i,o,n=this.getCanvasSize(),s=this.getPixelRatio();return e&&e.canvasSize&&(n=e.canvasSize),t=this.get("photo").getSizeToFit(n,e),i=Math.min(n.height/s,t.height),o=Math.min(n.width/s,t.width/t.height*i),i=Math.min(i,t.height/t.width*o),{width:Math.round(o),height:Math.round(i),url:t.url,pixelRatio:t.width/o}},getCanvasSize:function(){var e,t,i,o,n,s,a=this.getPixelRatio(),r=this.get("container"),h={width:500,height:500};return this.get("canvasSizeIsDirty")?YUI.Env.isServer||(t=this.get("container").ancestor(),i=r.getStyle("paddingTop")?parseInt(r.getStyle("paddingTop").match(/[0-9]+/)[0],10):0,o=r.getStyle("paddingBottom")?parseInt(r.getStyle("paddingBottom").match(/[0-9]+/)[0],10):0,s=40,n=40,t&&((e=t.get("region")).height=parseInt(t.getStyle("height").match(/[0-9]+/)[0],10)-(i+o),e.width=this.appContext.viewportData.viewport.width-(s+n))):e=this.get("cachedCanvasSize"),this.appContext.viewportData.viewport.width>0&&(h={width:this.appContext.viewportData.viewport.width,height:this.appContext.viewportData.viewport.height-240}),e||(e={top:0,left:0,bottom:500,right:500,width:h.width,height:h.height}),e.height*=a,e.width*=a,e},getPixelRatio:function(){return this.appContext.getViewer().getPixelRatio()},destructor:function(){var e=this;this.isAd&&window.googletag.cmd.push(function(){window.googletag.destroySlots(e.adSlots)})}},{ATTRS:{canvasSizeIsDirty:{value:!0,setter:function(e){return!!e}},cachedCanvasSize:{getter:function(t){return e.merge(t)},setter:function(t){return e.merge(t)}}}})},"@VERSION@",{requires:["flickr-view","moment","vr-overlay-view","zoom-view","hermes-template-photo-well-media-scrappy","hermes-template-google-moola-position"],optional:["photo-models"],langBundles:["common","photo-page-scrappy"]});