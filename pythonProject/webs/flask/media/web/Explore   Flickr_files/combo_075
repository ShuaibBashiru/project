YUI.add("group-selection-view",function(t,i){var e=require("hermes-core/flog")(i);t.namespace("Views")[this.name]=t.Base.create("group-selection-view",t.Views["stuff-selection-view"],[],{langBundles:this.details.langBundles,initializer:function(t){return this.params=t,this.params.curationType="group",this.params.loadingText=t.loadingText||this.intlMessage({intlName:"more-menu-view.LOADING_GROUPS"}),this.params.placeholderSearch=t.placeholderSearch||this.intlMessage({intlName:"photo-page-scrappy.SEARCH_GROUPS"}),this.params.buttonTextCreateNew=t.buttonTextCreateNew||this.intlMessage({intlName:"add-to-stuff.CURATIONS_CREATE_NEW_GROUP"}),this.appContext.flipper.isFlipped("enable-group-creation")||(this.params.createUrl="/groups_create.gne"),this.noGroupsText="<div>"+this.intlMessage({intlName:"add-to-stuff.DONT_ADMIN_ANY_GROUPS"})+'</div><a href="/groups_guidelines.gne">'+this.intlMessage({intlName:"add-to-stuff.LEARN_TO_RUN_GROUP"})+"</a>",this.noGroupsOwnerText="<div>"+this.intlMessage({intlName:"add-to-stuff.HAVENT_JOINED_ANY_GROUPS"})+'</div><a href="/groups">'+this.intlMessage({intlName:"add-to-stuff.DISCOVER_GROUPS"})+"</a>",this.emptySearchText=this.intlMessage({intlName:"add-to-stuff.NO_GROUPS"}),this.params.noneText=t.noneText||this.noGroupsText,this.params.emptySearchText=t.emptySearchText||this.emptySearchText,this.pendingText=t.pendingText||this.intlMessage({intlName:"add-to-stuff.PENDING_APPROVAL"}),this.invitedText=t.invitedText||this.intlMessage({intlName:"photo-page-scrappy.INVITE_PENDING"}),this.inviteAdminText=t.inviteAdminText||this.intlMessage({intlName:"photo-page-scrappy.INVITE_PENDING"}),this.couldntAddToGroupText=this.intlMessage({intlName:"add-to-stuff.COULDNT_ADD_TO_GROUP"}),this.couldntAddToGroupTooManyText=this.intlMessage({intlName:"add-to-stuff.COULDNT_ADD_TO_GROUP_TOO_MANY"}),this.couldntAddToGroupTooManyNonProText=this.intlMessage({intlName:"add-to-stuff.COULDNT_ADD_TO_GROUP_TOO_MANY_NON_PRO"}),this.alreadyAddedMaximumToGroupText=this.intlMessage({intlName:"add-to-stuff.YOU_ALREADY_ADDED_MAXIMUM_TO_GROUP"}),this.couldntAcceptInviteText=this.intlMessage({intlName:"add-to-stuff.COULDNT_ACCEPT_GROUP_INVITE"}),this.couldntInviteText=this.intlMessage({intlName:"add-to-stuff.COULDNT_INVITE_TO_GROUP"}),this.couldntCancelInviteText=this.intlMessage({intlName:"add-to-stuff.COULDNT_CANCEL_GROUP_INVITE"}),this.couldntRemoveText=this.intlMessage({intlName:"add-to-stuff.COULDNT_REMOVE_FROM_GROUP"}),this.cancelText=this.intlMessage({intlName:"common.CANCEL"}),this.acceptText=this.intlMessage({intlName:"common.ACCEPT"}),this.approveText=this.intlMessage({intlName:"add-to-stuff.APPROVE"}),this.inlineCreation=void 0!==this.params.inlineGroupCreation&&this.params.inlineGroupCreation,this.dismissOnCreate=this.params.dismissOnCreate||this.params.dismissOnCreateGroup,this.dismissOnSelect=this.params.dismissOnSelect||this.params.dismissOnSelectGroup,this.pageCount=1,this.perPage=400,this.constructor.superclass.initializer.call(this,t),this},activate:function(){var t=this;return this.constructor.superclass.activate.call(this).then(function(){t.params.createUrl||t.registerEventHandler(t.createButton.on(["click","key"],function(){t.fire("showCreate",{type:t.curationType})},"down:13"))})},loadCurations:function(){var i={groupsModel:this.appContext.getModel("person-groups-models",this.appContext.getViewer().nsid),photoModel:this.appContext.getModel("photo-models",this.photoId),photoPrivacyModel:this.appContext.getModel("photo-privacy-models",this.photoId),pendingGroupsModel:this.appContext.getModel("photo-group-pendings-models",this.photoId),inviteGroupsModel:this.appContext.getModel("photo-group-invitations-models",this.photoId),photoGroupsModel:this.appContext.getModel("photo-groups-models",this.photoId).then(function(t){return t.getListPageByContinuation(500).then(function(){return t}.bind(this))}.bind(this)),pendingGroupRegistry:this.appContext.getModelRegistry("photo-group-pending-models")};return t.FlickrPromise(i).then(function(t){return this.groupsModel=t.groupsModel,this.photoModel=t.photoModel,this.photoPrivacyModel=t.photoPrivacyModel,this.pendingGroupsModel=t.pendingGroupsModel,this.inviteGroupsModel=t.inviteGroupsModel,this.photoGroupsModel=t.photoGroupsModel,this.pendingGroupRegistry=t.pendingGroupRegistry,this.pendingList=this.pendingGroupsModel.getValue("pendings").toJSON(),this.inviteList=this.inviteGroupsModel.getValue("groups").toJSON(),this.photoGroupsList=this.photoGroupsModel.getValue("groups").toJSON(),this.isPhotoOwner=this.photoModel.getValue("isOwner"),this.showPrivateWarning=!this.photoPrivacyModel.getValue("isPublic"),this.showPrivateWarning=!this.photoPrivacyModel.getValue("isPublic")&&(!localStorage.getItem("dontShowPrivatePhotoGroupsWarningAgain")||null===localStorage.getItem("dontShowPrivatePhotoGroupsWarningAgain"))&&this.isPhotoOwner,this.isPhotoOwner&&(this.noneText=this.noGroupsOwnerText),this.personGroupsList=[],this.groupsModel.getValue("groups").getPage({page:1,perPage:this.perPage}).then(function(t){return this.personGroupsList=this.groupsModel.getValue("groups").toJSON(),this.recursivelyLoadGroups()}.bind(this))}.bind(this)).then(this.setupCurationList.bind(this)).then(this.sortGroups.bind(this)).catch(function(t){throw e.error("Error loading groups",{err:t}),t}.bind(this))},recursivelyLoadGroups:function(){if(!this.groupsModel.getValue("groups").hasMaxBoundary())return this.groupsModel.getValue("groups").getPage({page:++this.pageCount,perPage:this.perPage}).then(function(t){return t.forEach(function(t){this.personGroupsList.push(t.toJSON())}.bind(this)),this.recursivelyLoadGroups()}.bind(this)).catch(function(t){throw e.error("Error loading groups",{err:t}),t}.bind(this))},setupCurationList:function(){this.curationList=this.personGroupsList,this.curationList=this.curationList.filter(function(t){return t.isPending=this.pendingList.some(function(i){return i.groupId===t.id}),t.group.isAdmin||this.photoModel.getValue("isOwner")}.bind(this)),this.curationList.forEach(function(t){t.curationId=t.id,t.isUserInGroup=!0,t.isPhotoInGroup=!1}),this.photoGroupsList.forEach(function(t){var i=this.getCurationById(t.id);(this.photoModel.getValue("isOwner")||t.group.isAdmin)&&(i?(i.hasPhoto=!0,i.isPhotoInGroup=!0):(t.hasPhoto=!0,t.isUserInGroup=t.group.isAdmin,t.isPhotoInGroup=!0,this.curationList.unshift(t)))}.bind(this)),this.inviteList.forEach(function(t){var i=this.getCurationById(t.id);(this.photoModel.getValue("isOwner")||t.group.isAdmin)&&(i?i.isInvited=!0:(t.isInvited=!0,this.curationList.unshift(t)))}.bind(this)),this.curationList.forEach(function(t,i){return t.curationId=t.id,t.isPending=this.pendingList.some(function(i){return i.groupId===t.curationId}),this.prepareCurationForList(t),t}.bind(this))},sortGroups:function(){var t=this,i=[],e=[],o=[];this.curationList=this.curationList.filter(function(t,s){return t.hasPhoto?(i.unshift(t),!1):t.isPending?(e.unshift(t),!1):!t.isInvited||(o.unshift(t),!1)}),e.forEach(function(i){t.curationList.unshift(i)}),o.forEach(function(i){t.curationList.unshift(i)}),i.forEach(function(i){t.curationList.unshift(i)})},addPhoto:function(t,i,e){return this.appContext.getModel("group-pool-models",t).then(function(t){return this.photoModel.getValue("isOwner")?this.addToGroup(t,this.photoId):e?this.acceptToGroup(t,this.photoId):this.inviteToGroup(t,this.photoId)}.bind(this))},addToGroup:function(t,i){var o=t.getValue("id"),s=this.getCurationById(o),n=this.get("container").one('.stuff-selection-list li[data-curation-id="'+o+'"]').one(".item-stats");return s.isInvited?this.inviteGroupsModel.registry.remote.acceptInvitation({groupID:s.id,userID:this.appContext.getViewer().nsid,photoID:this.photoId},this.appContext).then(function(t){return s.hasPhoto=!0,s.isPending=!1,s.isInvited=!1,this.updateStatDisplay(n,s.memberCountString),s}.bind(this)).catch(function(t){throw e.error("Error accepting invite to group",{err:t}),this.updateStatDisplay(n,this.couldntAcceptInviteText,!0),t}.bind(this)):t.addPhotoRemote(i).then(function(t){return s.hasPhoto=!0,s.isPending=!1,this.updateStatDisplay(n,s.memberCountString),s}.bind(this)).catch(function(t){if(4===t.code)return this.appContext.getModel("person-models",this.appContext.getViewer().nsid).then(function(i){throw this.updateStatDisplay(n,i.getValue("isPro")?this.couldntAddToGroupTooManyText:this.couldntAddToGroupTooManyNonProText,!0),t}.bind(this));if(5===t.code||11===t.code)throw this.updateStatDisplay(n,this.alreadyAddedMaximumToGroupText,!0),t;if(6===t.code){var i={id:[this.photoId,s.id].join("-"),photoId:this.photoId,groupId:s.id},o=this.pendingGroupRegistry.addOrUpdate(i);return this.pendingGroupsModel.getValue("pendings").appendToList(o),this.setStatDisplay(s,this.pendingText,this.cancelText),s.isPending=!0,this.updateStatDisplay(n,s.statDisplay),s}throw e.error("Error adding to group",{err:t}),this.updateStatDisplay(n,this.couldntAddToGroupText,!0),t}.bind(this))},inviteToGroup:function(t,i){var o=t.getValue("id"),s=this.getCurationById(o),n=this.get("container").one('.stuff-selection-list li[data-curation-id="'+o+'"]').one(".item-stats");return t.invitePhotoRemote(i).then(function(t){return this.setStatDisplay(s,this.inviteAdminText,this.cancelText),s.isInvited=!0,this.updateStatDisplay(n,s.statDisplay),s}.bind(this)).catch(function(t){if(6===t.code)return s.isPending=!0,s;throw e.error("Error inviting to group",{err:t}),this.updateStatDisplay(n,this.couldntInviteText,!0),t}.bind(this))},acceptToGroup:function(t,i){var o=this,s=t.getValue("id"),n=this.getCurationById(s),r=this.get("container").one('.stuff-selection-list li[data-curation-id="'+s+'"]').one(".item-stats");return t.acceptPhotoRemote(i).then(function(t){return n.hasPhoto=!0,n.isPending=!1,n.isInvited=!1,o.updateStatDisplay(r,n.memberCountString),n}).catch(function(t){throw e.error("Error accepting to group",{err:t}),o.updateStatDisplay(r,o.couldntAddToGroupText,!0),t})},removePhoto:function(t){return this.appContext.getModel("group-pool-models",t).then(function(t){return this.removeFromGroup(t,this.photoId)}.bind(this))},removeFromGroup:function(t,i){var o=t.getValue("id"),s=this.getCurationById(o),n=this.get("container").one('.stuff-selection-list li[data-curation-id="'+o+'"]'),r=n.one(".item-stats");return s.isInvited?t.cancelPhotoInvitationRemote(this.photoId).then(function(t){return s.hasPhoto=!1,s.isPending=!1,s.isInvited=!1,this.updateStatDisplay(r,s.memberCountString),s}.bind(this)).catch(function(t){throw e.error("Error cancelling invite to group",{err:t}),this.updateStatDisplay(r,this.couldntCancelInviteText,!0),t}.bind(this)):t.removePhotoRemote(i).then(function(t){var i=[this.photoId,s.id].join("-");return s.hasPhoto=!1,s.isPending=!1,s.isInvited=!1,this.setStatDisplay(s,s.memberCountString),this.pendingGroupRegistry.remove(i),this.pendingGroupsModel.getValue("pendings").removeFromList(i),this.updateStatDisplay(r,s.statDisplay),s.isUserInGroup||(n.remove(),this.curationList=this.curationList.filter(function(t){return t.id!==o})),s}.bind(this)).catch(function(t){throw e.error("Error removing from group",{err:t}),this.updateStatDisplay(r,this.couldntRemoveText,!0),t})},prepareCurationForList:function(i){i.curationId=i.id,i.bestIconURL=i.group.bestIconURL,i.title=t.flutil.unescape(i.group.title),i.memberCountString=i.group.memberCount+" "+this.intlMessage({intlName:"groups.GROUPS_SUBNAV_MEMBERS",count:i.group.memberCount}),i.isPending?this.isPhotoOwner?this.setStatDisplay(i,this.pendingText,this.cancelText):this.setStatDisplay(i,this.pendingText,this.approveText):i.isInvited?this.isPhotoOwner?this.setStatDisplay(i,this.invitedText,this.acceptText):this.setStatDisplay(i,this.inviteAdminText,this.cancelText):this.setStatDisplay(i,i.memberCountString)},setStatDisplay:function(t,i,e){t.statDisplay=e?i+' — <span class="stat-action">'+e+"</span>":i},updateStatDisplay:function(i,e,o){o?(e=t.StringHelper.preventOrphans(e),i.addClass("error-message")):i.removeClass("error-message"),i.setHTML(e)},displayPrivateWarning:function(){var t;this.curationListNode.addClass("hidden-with-warning"),this.createButton.setAttribute("disabled"),this.curationListContainerNode.append(this.templates("private-photo-group-add-warning")({})),this.warningNode=this.curationListContainerNode.one(".private-warning-container"),t=this.warningNode.one(".private-warning-accept"),this.searchBox.setAttribute("disabled"),t.focus(),this.registerEventHandler(t.on(["click","key"],function(){this.warningNode.one("input").get("checked")&&localStorage.setItem("dontShowPrivatePhotoGroupsWarningAgain",!0),this.warningNode.remove(),this.curationListNode.removeClass("hidden-with-warning"),this.createButton.removeAttribute("disabled"),this.searchBox.removeAttribute("disabled"),this.searchBox.focus()}.bind(this),"down:13"))}})},"@VERSION@",{requires:["flickr-view","flickr-promise","stuff-selection-view","fluid-modal-view","group-creation-view","string-helper","curation-helper"],langBundles:["more-menu-view","photo-page-scrappy","common","header","groups","stats","add-to-stuff"]});